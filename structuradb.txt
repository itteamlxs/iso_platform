# Base de Datos: Sistema de Gestión de Cumplimiento ISO

## Descripción General
Base de datos diseñada para gestionar el cumplimiento de controles de seguridad de la información según estándares ISO, permitiendo el seguimiento de empresas, controles, evidencias y planes de acción.

---

## **TABLAS PRINCIPALES**

### 1. **empresas**
Almacena información de las empresas que utilizan el sistema.

| Campo | Tipo | Descripción |
|-------|------|-------------|
| id | INT(11) PK | Identificador único |
| nombre | VARCHAR(255) | Nombre de la empresa |
| ruc | VARCHAR(20) | RUC único |
| direccion | TEXT | Dirección física |
| telefono | VARCHAR(20) | Teléfono de contacto |
| email_contacto | VARCHAR(100) | Email de contacto |
| sector | VARCHAR(100) | Sector empresarial |
| fecha_registro | TIMESTAMP | Fecha de registro |
| estado | ENUM | Estado: activa/inactiva/suspendida |

### 2. **controles_dominio**
Dominios de controles organizacionales.

| Campo | Tipo | Descripción |
|-------|------|-------------|
| id | INT(11) PK | Identificador único |
| codigo | VARCHAR(10) | Código del dominio |
| nombre | VARCHAR(255) | Nombre del dominio |

**Datos:**
- 5: Controles Organizacionales
- 6: Controles de Personas  
- 7: Controles Físicos
- 8: Controles Tecnológicos

### 3. **controles**
Controles específicos de seguridad organizados por dominio.

| Campo | Tipo | Descripción |
|-------|------|-------------|
| id | INT(11) PK | Identificador único |
| codigo | VARCHAR(20) | Código del control |
| nombre | VARCHAR(255) | Nombre del control |
| descripcion | TEXT | Descripción detallada |
| dominio_id | INT(11) FK | Referencia a controles_dominio |

**Ejemplos de controles:**
- 5.1: Políticas de seguridad de la información
- 5.2: Roles y responsabilidades en seguridad
- 8.1: Dispositivos de usuario final
- 8.20: Seguridad de las redes

**Total:** 93 controles organizados en 4 dominios

### 4. **soa_entries**
Relación entre empresas y controles (Statement of Applicability).

| Campo | Tipo | Descripción |
|-------|------|-------------|
| id | INT(11) PK | Identificador único |
| empresa_id | INT(11) FK | Referencia a empresas |
| control_id | INT(11) FK | Referencia a controles |
| aplicable | TINYINT(1) | Si el control es aplicable |
| justificacion | TEXT | Justificación si no aplica |
| estado | ENUM | Estado: implementado/parcial/no_implementado |
| fecha_evaluacion | TIMESTAMP | Fecha de última evaluación |
| evaluador | VARCHAR(100) | Persona que evaluó |

### 5. **gap_items**
Registro de brechas identificadas en los controles.

| Campo | Tipo | Descripción |
|-------|------|-------------|
| id | INT(11) PK | Identificador único |
| soa_id | INT(11) FK | Referencia a soa_entries |
| brecha | TEXT | Descripción de la brecha |
| objetivo | TEXT | Objetivo a alcanzar |
| prioridad | ENUM | Prioridad: alta/media/baja |
| avance | INT(11) | Porcentaje de avance (0-100) calculado automáticamente |
| fecha_estimada_cierre | DATE | Fecha estimada de cierre |
| fecha_real_cierre | DATE | Fecha real de cierre (automática al 100%) |
| responsable | VARCHAR(100) | Persona responsable |
| estado_gap | VARCHAR(20) DEFAULT 'activo' | Estado del GAP: activo/eliminado (soft delete) |

**Restricción:** Solo pueden crearse GAPs en controles con `aplicable = 1`

### 6. **acciones** [ACTUALIZADA v3.0]
Plan de acción para cerrar brechas.

| Campo | Tipo | Descripción |
|-------|------|-------------|
| id | INT(11) PK | Identificador único |
| gap_id | INT(11) FK | Referencia a gap_items |
| descripcion | TEXT | Descripción de la acción |
| responsable | VARCHAR(100) | Persona responsable |
| fecha_compromiso | DATE | Fecha comprometida |
| fecha_inicio | DATE | Fecha de inicio real |
| fecha_finalizacion | DATE | Fecha de finalización |
| estado | ENUM | Estado operativo: pendiente/en_progreso/completada |
| estado_accion | ENUM | Estado de eliminación: activo/eliminada (soft delete) |
| notas | TEXT | Notas adicionales |

**Cambio importante:** 
- Nueva columna `estado_accion` para soft delete consistente con `gap_items`
- Columna `estado` ahora solo maneja estados operativos (eliminado 'inactiva')
- Índice `idx_estado_accion` para optimizar queries

### 7. **evidencias**
Evidencias de implementación de controles.

| Campo | Tipo | Descripción |
|-------|------|-------------|
| id | INT(11) PK | Identificador único |
| empresa_id | INT(11) FK | Referencia a empresas |
| control_id | INT(11) FK | Referencia a controles |
| descripcion | TEXT | Descripción de la evidencia |
| tipo_evidencia_id | INT(11) FK | Tipo de evidencia |
| estado_validacion | ENUM | Estado: pendiente/aprobada/rechazada |
| comentarios_validacion | TEXT | Comentarios del validador |
| validado_por | INT(11) FK | Usuario que validó |
| fecha_validacion | TIMESTAMP | Fecha de validación |
| archivo | VARCHAR(255) | Ruta del archivo subido |
| fecha_subida | TIMESTAMP | Fecha de subida |

**Restricción:** Solo controles con `aplicable = 1` pueden tener evidencias

### 8. **tipos_evidencia**
Catálogo de tipos de evidencias.

| Campo | Tipo | Descripción |
|-------|------|-------------|
| id | INT(11) PK | Identificador único |
| nombre | VARCHAR(100) | Nombre del tipo |
| descripcion | TEXT | Descripción |
| activo | TINYINT(1) | Si está activo |

**Tipos disponibles:**
- Política, Procedimiento, Registro, Certificado, Acta, Informe, Captura de pantalla, Manual, Contrato, Otro

### 9. **requerimientos_base**
Requerimientos base del sistema.

| Campo | Tipo | Descripción |
|-------|------|-------------|
| id | INT(11) PK | Identificador único |
| numero | INT(11) | Número de requerimiento |
| identificador | VARCHAR(50) | Identificador único |
| descripcion | TEXT | Descripción |
| objetivo | TEXT | Objetivo del requerimiento |
| activo | TINYINT(1) | Si está activo |

**Ejemplos de requerimientos:**
1. Manual de políticas de Seguridad de la Información
2. Inventario de activos de información  
3. Plan anual de capacitaciones actualizado
4. Estrategia documentada de concientización de SI
5. Evidencia de cumplimiento de plan y estrategia
6. Manual de gestión de incidentes de SI
7. Evidencia de política, procedimiento y reportes de monitoreo

### 10. **empresa_requerimientos**
Relación entre empresas y requerimientos.

| Campo | Tipo | Descripción |
|-------|------|-------------|
| id | INT(11) PK | Identificador único |
| empresa_id | INT(11) FK | Referencia a empresas |
| requerimiento_id | INT(11) FK | Referencia a requerimientos_base |
| estado | ENUM | Estado: pendiente/en_proceso/completado/no_aplica |
| evidencia_documento | VARCHAR(255) | Documento de evidencia |
| fecha_entrega | DATE | Fecha de entrega |
| observaciones | TEXT | Observaciones |

**Lógica de completitud automática:**
- Se marca como 'completado' automáticamente cuando:
  1. TODOS los controles asociados están en estado 'implementado'
  2. CADA control tiene AL MENOS UNA evidencia con `estado_validacion = 'aprobada'`

### 11. **requerimientos_controles**
Relación entre requerimientos base y controles específicos.

| Campo | Tipo | Descripción |
|-------|------|-------------|
| id | INT(11) PK | Identificador único |
| requerimiento_base_id | INT(11) FK | Referencia a requerimientos_base |
| control_id | INT(11) FK | Referencia a controles |
| fecha_creacion | TIMESTAMP | Fecha de creación |

**Datos:** 126 relaciones que vinculan los 7 requerimientos base con los controles correspondientes

---

## **TABLAS ADICIONALES**

### 12. **usuarios**
Usuarios del sistema.

| Campo | Tipo | Descripción |
|-------|------|-------------|
| id | INT(11) PK | Identificador único |
| nombre | VARCHAR(100) | Nombre completo |
| email | VARCHAR(100) | Email único |
| contrasena_hash | VARCHAR(255) | Hash de contraseña |
| rol | ENUM | Rol: admin/auditor/consultor |
| creado_en | TIMESTAMP | Fecha de creación |

### 13. **auditorias**
Registro de auditorías realizadas.

| Campo | Tipo | Descripción |
|-------|------|-------------|
| id | INT(11) PK | Identificador único |
| empresa_id | INT(11) FK | Referencia a empresas |
| fecha | DATE | Fecha de auditoría |
| auditor | VARCHAR(100) | Nombre del auditor |
| resumen | TEXT | Resumen de hallazgos |
| resultado | ENUM | Resultado: conforme/no_conforme/observacion |

### 14. **comentarios_control**
Comentarios sobre controles específicos.

| Campo | Tipo | Descripción |
|-------|------|-------------|
| id | INT(11) PK | Identificador único |
| soa_id | INT(11) FK | Referencia a soa_entries |
| usuario_id | INT(11) FK | Referencia a usuarios |
| comentario | TEXT | Comentario |
| fecha | TIMESTAMP | Fecha del comentario |

### 15. **historial_estado**
Historial de cambios de estado en controles.

| Campo | Tipo | Descripción |
|-------|------|-------------|
| id | INT(11) PK | Identificador único |
| control_id | INT(11) FK | Referencia a controles |
| estado_anterior | ENUM | Estado anterior |
| nuevo_estado | ENUM | Nuevo estado |
| fecha | TIMESTAMP | Fecha del cambio |
| usuario_id | INT(11) FK | Usuario que realizó el cambio |

### 16. **riesgos**
Registro de riesgos identificados.

| Campo | Tipo | Descripción |
|-------|------|-------------|
| id | INT(11) PK | Identificador único |
| empresa_id | INT(11) FK | Referencia a empresas |
| descripcion | TEXT | Descripción del riesgo |
| probabilidad | ENUM | Probabilidad: alta/media/baja |
| impacto | ENUM | Impacto: alto/medio/bajo |
| nivel_calculado | VARCHAR(10) | Nivel calculado |
| control_asociado | INT(11) FK | Control asociado para mitigar |

---

## **VISTAS DEL SISTEMA**

### 1. **view_dashboard_summary**
Resumen general del sistema:
- Total de controles
- Controles implementados vs no implementados
- Gaps de alta prioridad (solo activos)
- Acciones pendientes (solo activas)

### 2. **view_dashboard_empresa**
Resumen por empresa:
- Total de controles por estado
- Porcentaje de cumplimiento
- Controles no aplicables

### 3. **view_controles_dominio_empresa**
Estadísticas de controles por dominio y empresa:
- Implementados, parciales, no implementados por dominio
- Porcentaje de implementación por dominio

### 4. **view_evidencias_empresa**
Estadísticas de evidencias por empresa:
- Total de evidencias
- Aprobadas, pendientes, rechazadas

### 5. **view_gap_avance_empresa**
Estadísticas de brechas por empresa:
- Total de gaps por prioridad (solo activos)
- Promedio de avance

### 6. **view_requerimientos_empresa**
Estadísticas de requerimientos por empresa:
- Completados, en proceso, pendientes
- Porcentaje de completado

### 7. **view_control_estado**
Estado de controles con conteo de evidencias:
- Código y nombre del control
- Estado actual
- Número de evidencias asociadas

### 8. **view_gap_prioridad**
Gaps organizados por prioridad:
- ID del gap
- Código del control asociado
- Descripción de la brecha
- Prioridad y avance actual
- **Filtro:** Solo GAPs con `estado_gap = 'activo'`

---

## **PROCEDIMIENTOS ALMACENADOS**

### 1. **sp_inicializar_soa_empresa**
Inicializa los 93 controles para una empresa nueva.

**Parámetros:**
- `p_empresa_id`: ID de la empresa

**Funcionalidad:**
- Verifica que no existan SOA entries previos
- Crea 93 registros en soa_entries con estado 'no_implementado'

### 2. **sp_inicializar_requerimientos_empresa**
Inicializa los requerimientos base para una empresa.

**Parámetros:**
- `p_empresa_id`: ID de la empresa

**Funcionalidad:**
- Verifica que no existan requerimientos previos
- Crea registros en empresa_requerimientos con estado 'pendiente'

---

## **TRIGGERS**

### **trg_after_insert_empresa**
Se ejecuta automáticamente después de insertar una nueva empresa:

1. **Crea SOA entries:** 93 registros en soa_entries (uno por cada control)
2. **Crea requerimientos:** Registros en empresa_requerimientos basados en requerimientos_base activos

---

## **RELACIONES PRINCIPALES**
```
empresas (1) ──── (N) soa_entries (N) ──── (1) controles
                        │
                        └─── (N) gap_items (1) ──── (N) acciones
                        │         │                        │
                        │         └─ estado_gap          └─ estado_accion
                        │            (activo/eliminado)     (activo/eliminada)
                        │
                        └─── (N) evidencias
                        │
                        └─── (N) comentarios_control

empresas (1) ──── (N) empresa_requerimientos (N) ──── (1) requerimientos_base
                                                              │
                                                              └─── (N) requerimientos_controles (N) ──── (1) controles

controles (N) ──── (1) controles_dominio
```

---

## **ÍNDICES CLAVE**

### Índices Únicos:
- `empresas.ruc` - RUC único por empresa
- `controles.codigo` - Código único por control
- `controles_dominio.codigo` - Código único por dominio
- `usuarios.email` - Email único por usuario
- `uk_empresa_req` - Combinación única empresa + requerimiento
- `uk_req_control` - Combinación única requerimiento_base + control

### Índices de Rendimiento:
- `idx_empresa_control` - Para búsquedas rápidas en soa_entries
- `idx_soa` - Para comentarios de control
- `idx_nombre`, `idx_ruc` - Para búsquedas de empresas
- `idx_req_base` - Para requerimientos_controles
- `idx_control` - Para requerimientos_controles
- `idx_estado_accion` - Para filtrado eficiente de acciones activas [NUEVO]

---

## **FLUJO DE TRABAJO TÍPICO**

1. **Registro de Empresa:** Se crea empresa → Trigger crea automáticamente SOA entries y requerimientos
2. **Evaluación de Controles:** Se evalúa cada control (implementado/parcial/no_implementado)
3. **Identificación de Brechas:** Para controles no implementados, se crean gap_items (SOLO en controles aplicables)
4. **Plan de Acción:** Se definen acciones específicas para cerrar brechas
5. **Cálculo Automático:** El avance del GAP se calcula automáticamente según acciones completadas
6. **Evidencias:** Se suben evidencias de implementación (SOLO en controles aplicables)
7. **Validación:** Evidencias se aprueban/rechazan
8. **Completitud Automática:** Requerimientos se marcan como completados automáticamente cuando:
   - Todos sus controles están implementados
   - Todos tienen evidencias aprobadas
9. **Seguimiento:** Se monitorea avance de gaps y acciones (solo activos)
10. **Soft Delete:** GAPs y acciones eliminados permanecen en BD pero no afectan cálculos
11. **Reportes:** Vistas y dashboard muestran solo registros activos

---

## **CAMBIOS RECIENTES**

### Versión Actual (v3.1):

#### **Migración BD (2025-01):**
- **Nueva columna:** `acciones.estado_accion` ENUM('activo', 'eliminada')
- **Modificado:** `acciones.estado` ahora solo ENUM('pendiente', 'en_progreso', 'completada')
- **Eliminado:** Valor 'inactiva' del ENUM estado
- **Nuevo índice:** `idx_estado_accion` en tabla acciones
- **Backup:** Tabla `acciones_backup_migration` creada durante migración

#### **Mejoras de Lógica:**
- **GAPs:** Solo pueden crearse en controles con `aplicable = 1`
- **Avance automático:** Se calcula SOLO con acciones donde `estado_accion = 'activo'`
- **Soft delete consistente:** 
  - `gap_items.estado_gap = 'eliminado'`
  - `acciones.estado_accion = 'eliminada'`
- **Completitud requerimientos:** Validación estricta en 3 pasos:
  1. Verificar controles aplicables asociados
  2. Validar TODOS en estado 'implementado'
  3. Validar CADA UNO con evidencias `estado_validacion = 'aprobada'`

#### **Mejoras UI/UX:**
- Links directos desde controles a requerimientos con scroll automático
- Highlight visual de 5 segundos en requerimientos
- Dashboard filtra correctamente registros eliminados

#### **Datos:**
- 93 controles
- 7 requerimientos base
- 126 relaciones requerimientos-controles
- Soft delete en cascada: GAP → Acciones

---

## **REGLAS DE NEGOCIO CRÍTICAS**

1. **Control No Aplicable:**
   - NO puede tener GAPs
   - NO puede tener evidencias
   - Justificación obligatoria

2. **GAP Items:**
   - Solo en controles aplicables
   - Avance calculado automáticamente
   - Soft delete en cascada a acciones
   - Al 100% → `fecha_real_cierre` se registra automáticamente

3. **Acciones:**
   - Estados operativos independientes de eliminación lógica
   - Solo acciones activas cuentan para avance
   - Eliminadas permanecen en BD para auditoría

4. **Requerimientos:**
   - Completitud automática con validación estricta
   - Requiere evidencias APROBADAS en TODOS los controles
   - Evidencias pendientes/rechazadas NO cuentan

5. **Dashboard:**
   - Solo muestra GAPs con `estado_gap = 'activo'`
   - Solo muestra acciones con `estado_accion = 'activo'`
   - Estadísticas excluyen registros eliminados

---

Esta estructura permite un seguimiento completo del cumplimiento de controles de seguridad ISO, desde la evaluación inicial hasta el cierre de brechas, con capacidad de reporteo y auditoría integral, manteniendo integridad referencial mediante soft delete.